parameters:
  publisherId: # Published Id @ https://marketplace.visualstudio.com/manage
  projName: # Required: Extension Name
  marketplaceServiceConnection: # Required: Service connection for Visual Studio Marketplace
  artifactName: 'extension-artifact' # Artifact name
  extensionVisibility: private # private | privatepreview | publicpreview | public
  extensionTag: # Extension Tag to append to the extension ID
  extensionName: 'Pipeline Triggerer' # Extension Name to override manifests's one

steps:
  - download: current
    artifact: ${{parameters.artifactName}}
    patterns: '**/*'

  - task: TfxInstaller@2
    displayName: 'Use Node CLI for Azure DevOps: v0.7.x'
    inputs:
      version: v0.7.x
    enabled: false

  - task: QueryAzureDevOpsExtensionVersion@2
    displayName: 'Query Extension Version'
    inputs:
      connectTo: 'VsTeam'
      connectedServiceName: ${{parameters.marketplaceServiceConnection}}
      publisherId: ${{parameters.publisherId}}
      extensionId: ${{parameters.projName}}
      versionAction: 'Patch'
      #extensionVersionOverride: 'Extension.VersionOverride'
      outputVariable: 'ExtensionVersion'
      # setBuildNumber: 'true'
      # arguments: 'asdasd'
      # cwd: 'asdasd'

  - task: PublishAzureDevOpsExtension@2
    displayName: 'Publish Extension'
    inputs:
      connectTo: 'VsTeam'
      connectedServiceName: 'vs-marketplace'
      fileType: vsix
      vsixFile: '$(Pipeline.Workspace)/${{parameters.artifactName}}/${{parameters.publisherId}}.${{parameters.projName}}-*.vsix'
      publisherId: ${{parameters.publisherId}}
      extensionName: ${{parameters.extensionName}}
      updateTasksVersionType: 'patch'
      extensionPricing: free
      outputVariable: ExtensionOutputPath
      shareWith: ${{parameters.publisherId}}
      extensionVisibility: ${{parameters.extensionVisibility}}
      extensionTag: ${{parameters.extensionTag}}
      extensionVersion: $(ExtensionVersion)

      # extensionId: 'asdasdasd'
      # extensionName: 'asdas'
      # extensionVersion: 'asdasdasd'
      # extensionVisibility: 'privatepreview'
      # bypassLocalValidation: true
      # noWaitValidation: true
      # arguments: 'adasda'
      # cwd: 'sdasdasd'

  # - task: ms-devlabs.vsts-developer-tools-build-tasks.publish-extension-build-task.PublishExtension@1
  #   displayName: 'Publish Extension'
  #   inputs:
  #     connectedServiceName: ${{parameters.marketplaceServiceConnection}}
  #     fileType: vsix
  #     vsixFile: '$(Pipeline.Workspace)/${{parameters.artifactName}}/${{parameters.publisherId}}.${{parameters.projName}}-*.vsix'
  #     extensionName: 'Pipeline Triggerer Extension'
  #     updateTasksVersion: false
  #     extensionVisibility: ${{parameters.extensionVisibility}}
  #     extensionPricing: free
  #     outputVariable: ExtensionOutputPath

  # - task: ShareAzureDevOpsExtension@2
  #   displayName: 'Share Extension'
  #   inputs:
  #     connectTo: 'VsTeam'
  #     connectedServiceName: 'vs-marketplace'
  #     method: vsix
  #     vsixFile: '$(Pipeline.Workspace)/${{parameters.artifactName}}/${{parameters.publisherId}}.${{parameters.projName}}-*.vsix'
  #     accounts: ${{parameters.publisherId}}
  #     # publisherId: 'asd'
  #     # extensionId: 'asdas'
  #     # extensionTag: 'asd'
  #     # arguments: 'asd'
  #     # cwd: 'asd'


  # - task: ms-devlabs.vsts-developer-tools-build-tasks.share-extension-build-task.ShareExtension@1
  #   inputs:
  #     connectedServiceName: ${{parameters.marketplaceServiceConnection}}
  #     method: vsix
  #     vsixFile: '$(Pipeline.Workspace)/${{parameters.artifactName}}/${{parameters.publisherId}}.${{parameters.projName}}-*.vsix'
  #     accounts: ${{parameters.publisherId}}